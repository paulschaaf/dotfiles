#!/bin/zsh

playerHost=copernicus
thisFile=${(F)0:t}

if [[ "$1" == "--setx" ]]; then
  shift
  set -x
fi

if [[ `hostname` = "${playerHost}" ]]; then
  (( $# )) && playerctl -p strawberry "${@}" # arguments are a command

  RESPONSE=$(playerctl -p strawberry metadata --format 'artist="{{xesam:artist}}"; song="{{xesam:title}}"; album="{{xesam:album}}"; track="{{xesam:trackNumber}}"; year="{{year}}"; playStatus="{{lc(status)}}"; position="{{duration(position)}}"; length="{{duration(mpris:length)}}"' 2>/dev/null || echo "title='${thisFile}'; message='Error: No track is selected'")

else
  RESPONSE=$(ssh -x ${playerHost} ${thisFile} "${@}" || echo "'title='${thisFile}'; message='Error: Cannot reach $playerHost'")
fi

echo $RESPONSE; echo
eval $RESPONSE

# shellcheck disable=SC2154 # var referenced but not assigned
title=${title:-$song}

# shellcheck disable=SC2154 # var referenced but not assigned
subtitle="$artist"

# shellcheck disable=SC2154 # var referenced but not assigned
if ((! $#message)); then
  message="\\\"$album\" [$year]
$position / $length ($playStatus track $track)"
fi

if [[ $UNAME = "Darwin" ]]; then
  cmd=(alerter -timeout 5 -title ${title} ${subtitle:+-subtitle} ${subtitle} ${message:+-message} ${message})
  echo ${(q)cmd}
  ${cmd[*]} &
else
  notify-send -a "$title" "$subtitle
$message"
fi