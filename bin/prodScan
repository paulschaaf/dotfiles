#!/usr/bin/env zsh
products=(bc cc ab pc px)
platform=halite

switches=()
alias dry_run=false
while [[ -n "$*" ]]; do
   switch=${1%%=*}; [[ ${switch} =~ "=" ]] && value=${1#*=} || value=''
   case ${switch} in
      --debug)
         set -x
         ;;
      --dry_run|--dry-run)
         alias dry_run=true
         ;;
      --platform)
        platform=$value
        ;;
#      -h|--help)
#         usage
#         exit
#         ;;
      --none)
        products=()
        ;;
      --no*)
        product=${switch##--no}
        if (($products[(Ie)$product])); then
          # remove the offending product
          products[$products[(i)$product]]=()
        else
          echo "Unrecognized product '$product'" >&2
          exit 1
        fi
        ;;
      -*)
        product=${switch##--}
        if (($products[(Ie)$product])); then
          # either add the product (e.g. "ab=ab", or remap the product (e.g. "Cc"="cc2")
          products[$products[(i)${product}]]=${value:=$product}
        else # it's a normal switch
          switches+=(${1})
        fi
       ;;
      *)
        break
        ;;
   esac
   shift
done

cd ~/gw/$platform

for prod in $products; do
  name=`sed -n 's/^appName=//gp' $prod/gradle.properties`

  printf "\n${GW_COLORS[$name]}%s%$(($COLUMNS-$#name))s\e[0m\n" $name "${PWD//$HOME/~}/$prod"
  rg --color=always --case-sensitive ${switches} ${*} $prod
done
