#!/bin/bash

GW_PLATFORM_old=$GW_PLATFORM
GW_ROOT_old=$GW_ROOT

GW_PLATFORM=`echo $PWD | sed -n '
# check if the path explicitly names the platform version
s/.*\(carbon\|diamond\|emerald\|ferrite\|granite\).*/\1/

# otherwise extract the version number
s/.*\(bc\|cc\|pc\|ab\|cm\|Center\|Manager\)_*0*\(1[0-9]\|[1-9]\).*/\2/

# exit now if no substitutions were made
T

# otherwise print what we found
p'`

case ${GW_PLATFORM} in
    6|carbon)
        export GW_PL_NUM=6
        export GW_PLATFORM=carbon
        export IDEA_HOME=$IDEA11_HOME
        export JAVA_HOME=$JAVA6_HOME_x86
        export IDEA_JDK=$JAVA6_HOME
        scriptExtension=.sh
        typeset -p AARDVARK_HOME ANT_HOME M2_HOME
        ;;
    7|diamond)
        export GW_PL_NUM=7
        export GW_PLATFORM=diamond
        export IDEA_HOME=$IDEA12_HOME
        export JAVA_HOME=$JAVA6_HOME_x86
        export IDEA_JDK=$JAVA6_HOME
        scriptExtension=.sh
        typeset -p AARDVARK_HOME ANT_HOME M2_HOME
        ;;
    8|emerald)
        export GW_PL_NUM=8
        export GW_PLATFORM=emerald
        export IDEA_HOME=$IDEA12_HOME
        export JAVA_HOME=$JAVA7_HOME
        export IDEA_JDK=$JAVA_HOME
        scriptExtension=.sh
        typeset -p AARDVARK_HOME ANT_HOME M2_HOME
        ;;
    9|ferrite)
        export GW_PL_NUM=9
        export GW_PLATFORM=ferrite
        export IDEA_HOME=$IDEA15_HOME
        export JAVA_HOME=$JAVA8_HOME
        export IDEA_JDK=$JAVA_HOME
        ;;
    10|granite)
        export GW_PL_NUM=10
        export GW_PLATFORM=granite
        export IDEA_HOME=$IDEA15_HOME
        export JAVA_HOME=$JAVA8_HOME
        export IDEA_JDK=${JAVA8_HOME}_nodcevm
        ;;
    *)
        unset GW_PLATFORM
        export IDEA_HOME=$IDEA15_HOME
        export JAVA_HOME=$JAVA8_HOME
        export IDEA_JDK=${JAVA8_HOME}_nodcevm
        ;;
esac
echo GW_PLATFORM=$GW_PLATFORM

if [ -z "$GW_PLATFORM" ]; then  # we're not in a gw install
    if [ -z "$GW_PLATFORM_old" ]; then  # and we weren't in one before
        echo "Still outside any GW build."

    else                        # we just exited an install
        echo "We've just moved outside of any GW install, so unset every var named GW_*"
        for var in `env | grep ^'GW_' | cut -d '=' -f 1`; do
            unset -v $var
        done
    fi
else
    export GW_ROOT=`echo $PWD/ | sed -n "s_^\(.*/${GW_PLATFORM}/[^/]*\).*/_\1_p"`
    export GW_PRODUCT=`echo $GW_ROOT | sed 's_.*/\(.*\)_\U\1_g'`
    GW_PRODUCT=${GW_PRODUCT:-gw}

    # Report on the new environment
    typeset -p IDEA_HOME JAVA_HOME
    [ -n "$IDEA_JDK" ] && typeset -p IDEA_JDK
    echo; java -version 2>&1; echo

    typeset -p GW_PL_NUM GW_PLATFORM GW_ROOT

    # assume we're NOT in Cygwin, then fix it if we're wrong
    ifCygwin=:
    if [ -n "$CYGPATH" ]; then
        ifCygwin=
    fi

    case ${GW_PRODUCT} in
        AB)
            export GW_PORT=8280
            export GW_COLOR='[106m' # bright white text on aqua
            $ifCygwin GW_COLOR=3F
            ;;
        BC)
            export GW_PORT=8380
            export GW_COLOR='[105m' # bright white text on magenta
            $ifCygwin GW_COLOR=2F
            ;;
        CC)
            export GW_PORT=8080
            export GW_COLOR='[104m' # bright white text on blue
            $ifCygwin GW_COLOR=1F
            ;;
        PC)
            export GW_PORT=8480
            export GW_COLOR='[103m' # bright white text on tan/yellow
            $ifCygwin GW_COLOR=4F
            ;;
        gw)
            export GW_COLOR='[30;107m' # bright black text on gray
            $ifCygwin GW_COLOR=4F
            ;;
        *)
            export GW_COLOR='[5;101m' # blinking bright white on red
            $ifCygwin GW_COLOR=0F
            ;;
    esac
    export GW_PORT_DEBUG=$(($GW_PORT + 10))

    # Determine the startup script
    export GW_START_SCRIPT=./gwb

    if [ ${GW_PL_NUM} -lt 9 ]; then
        GW_START_SCRIPT=bin/$GW_PRODUCT
    fi

    $ifCygwin set scriptExtension=.bat
    GW_START_SCRIPT=$GW_START_SCRIPT${scriptExtension}

    export GW_TITLE="$GW_PRODUCT$GW_PL_NUM"
    export GW_PROMPT="%{$GW_COLOR%}$GW_TITLE%{[0m%} "

    typeset -p GW_PRODUCT GW_START_SCRIPT GW_TITLE

    function echoList() {
        for arg in $*; do
            echo -e "\n$arg contains:"
            eval echo \${${arg}} | tr ':' '\n' | cat -n
        done
    }

    export PATH=${JAVA_HOME}/bin:${IDEA_HOME}/bin:${PATH}

    export CLASSPATH=$JAVA_HOME/lib/\*jar:'./lib/*jar':${CLASSPATH}
    # Remove any empty or duplicate members
    CLASSPATH=`echo -n $CLASSPATH | awk -v RS=: '{ if (!arr[$0]++) {printf("%s%s", ln++ ? ":" : "", $0)}}'`

    echoList PATH CLASSPATH

    # this will only work if you 'source' this file
    if [ -n "$inScreen" ]; then
        echo -n "\ek$GW_TITLE\e\\"  # the screen title
    fi

fi

set +x
unset GW_ROOT_old GW_PLATFORM_old
