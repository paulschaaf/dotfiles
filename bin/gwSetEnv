#!/bin/bash

function unsetGWVars () {
    echo "We've just moved outside of any GW install, so unset every var named GW_*"
    for var in `env | grep ^'GW_' | cut -d '=' -f 1`; do
        unset -v $var
    done
}

GW_PLATFORM=`echo $PWD | sed -rn '
# check if the path explicitly names the platform version
s/.*(carbon|diamond|emerald|ferrite|granite).*/\1/

# otherwise extract the version number from the install directory name
s/.*([bcp]c|ab|cm|Center|Manager)_*0*(1[0-9]|[1-9]).*/\2/

# if no substitutions were made--we could not determine the version--exit now with the empty string
T

# otherwise print what we found
p'`

case ${GW_PLATFORM} in
    6|carbon)
        export GW_PL_NUM=6
        export GW_PLATFORM=carbon
        export IDEA_HOME=$IDEA11_HOME
        export JAVA_HOME=$JAVA6_HOME_x86
        export IDEA_JDK=$JAVA6_HOME
        scriptExtension=.sh
        typeset -p AARDVARK_HOME ANT_HOME M2_HOME
        ;;
    7|diamond)
        export GW_PL_NUM=7
        export GW_PLATFORM=diamond
        export IDEA_HOME=$IDEA12_HOME
        export JAVA_HOME=${JAVA6_HOME_x86:-$JAVA6_HOME}
        export IDEA_JDK=$JAVA6_HOME
        scriptExtension=.sh
        typeset -p AARDVARK_HOME ANT_HOME M2_HOME
        ;;
    8|emerald)
        export GW_PL_NUM=8
        export GW_PLATFORM=emerald
        export IDEA_HOME=$IDEA12_HOME
        export JAVA_HOME=$JAVA7_HOME
        export IDEA_JDK=$JAVA_HOME
        scriptExtension=.sh
        typeset -p AARDVARK_HOME ANT_HOME M2_HOME
        ;;
    9|ferrite)
        export GW_PL_NUM=9
        export GW_PLATFORM=ferrite
        export IDEA_HOME=$IDEA15_HOME
        export JAVA_HOME=$JAVA8_HOME
        export IDEA_JDK=$JAVA_HOME
        ;;
    10|granite)
        export GW_PL_NUM=10
        export GW_PLATFORM=granite
        export IDEA_HOME=$IDEA15_HOME
        export JAVA_HOME=$JAVA8_HOME
        export IDEA_JDK=${JAVA8_HOME}_nodcevm
        ;;
    *)
        unsetGWVars
        export IDEA_HOME=$IDEA15_HOME
        export JAVA_HOME=$JAVA8_HOME
        export IDEA_JDK=${JAVA8_HOME}_nodcevm
        ;;
esac

if [ -n "$GW_PLATFORM" ]; then  # if we determined the platform
    typeset -p GW_PL_NUM GW_PLATFORM

    export GW_ROOT=`echo ${PWD//$HOME/'~'} | sed -rn "
s_((${GW_PLATFORM}|${GW_PL_NUM})/((ab|bc|cc|pc)/?(active/|release/))?[^/]*).*_\1_
T
p"`
    typeset -p GW_ROOT

    # Report on the new environment
    typeset -p IDEA_HOME JAVA_HOME
    [ -n "$IDEA_JDK" ] && typeset -p IDEA_JDK


    export GW_PRODUCT=`echo ${GW_ROOT} | sed -nr 's_^.*(ab|cm|ContactManager|[bcp]c|(Billing|Claim|Policy)Center).*_\L\1_ip'`
set +x
    ifCygwin=:  # make the subsequent command a no-op when we're not in Cygwin
    if [[ "$UNAME" =~ "CYGWIN" ]]; then
        # if we are in Cygwin, execute the subsequent command
        ifCygwin=
    fi

    case ${GW_PRODUCT} in
        ab|contactmanager)
            export GW_PRODUCT=ab
            export GW_PORT=8280
            export GW_COLOR='[106m' # bright white text on aqua
            $ifCygwin GW_COLOR=3F
            ;;
        bc|billingcenter)
            export GW_PRODUCT=bc
            export GW_PORT=8380
            export GW_COLOR='[105m' # bright white text on magenta
            $ifCygwin GW_COLOR=2F
            ;;
        cc|claimcenter)
            export GW_PRODUCT=cc
            export GW_PORT=8080
            export GW_COLOR='[104m' # bright white text on blue
            $ifCygwin GW_COLOR=1F
            ;;
        pc|policycenter)
            export GW_PRODUCT=pc
            export GW_PORT=8480
            export GW_COLOR='[103m' # bright white text on tan/yellow
            $ifCygwin GW_COLOR=4F
            ;;
        gw)
            export GW_PRODUCT=gw
            export GW_COLOR='[30;107m' # bright black text on gray
            $ifCygwin GW_COLOR=4F
            ;;
        *)
            unset GW_PRODUCT GW_TITLE GW_PROMPT
            export GW_COLOR='[5;101m' # blinking bright white on red
            $ifCygwin GW_COLOR=0F
            ;;
    esac

    typeset -p GW_PRODUCT

    if [ -z "${GW_PRODUCT}" ]; then
        unsetGWVars
    else
        export GW_PORT_DEBUG=$(($GW_PORT + 10))

        # Determine the startup script
        export GW_START_SCRIPT=./gwb

        if [ ${GW_PL_NUM} -lt 9 ]; then
            GW_START_SCRIPT=bin/$GW_PRODUCT
        fi

        $ifCygwin set scriptExtension=.bat
        GW_START_SCRIPT=$GW_START_SCRIPT${scriptExtension}

        export GW_TITLE="$GW_PRODUCT$GW_PL_NUM"
        export GW_PROMPT="%{$GW_COLOR%}$GW_TITLE%{[0m%} "

        typeset -p GW_PORT GW_PORT_DEBUG GW_START_SCRIPT GW_TITLE

        export PATH=`echo :$PATH | sed -r 's_:[^:]+(/java-[0-9]+-oracle|/idea[0-9]*)[^:]*__g; s/^://'`
        PATH=${JAVA_HOME}/bin:${IDEA_HOME}/bin:${PATH}

        export CLASSPATH="${JAVA_HOME}/lib/*jar:./lib/*jar:${CLASSPATH}"
        # Remove any empty or duplicate members
        CLASSPATH=`echo -n $CLASSPATH | awk -v RS=: '{ if (!arr[$0]++) {printf("%s%s", ln++ ? ":" : "", $0)}}'`

        function _echoList() {
            for arg in $*; do
                echo -e "\n$arg contains:"
                eval echo \${${arg}} | tr ':' '\n' | cat -n
            done
        }

        echo; java -version 2>&1; echo
        _echoList PATH CLASSPATH

        # this will only work if you 'source' this file
        if [ -n "$inScreen" ]; then
            echo -n "\ek$GW_TITLE\e\\"  # the screen title
        fi
    fi

fi
