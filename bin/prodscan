#!/usr/bin/env zsh
allProducts=(ab bc cc ccpi pc px)
typeset -A selectedProducts

switches=()
alias dry_run=false
root=~/gw
while [[ -n "$*" ]]; do
  switch=${1%%=*}
  [[ ${1} =~ "=" ]] && value=${1#*=} || value=''
  (($#debug)) && echo "Processing switch '$switch', value '$value'"
  case ${switch} in
    --debug)
      debug=true
      ;;
    --dry_run | --dry-run)
      alias dry_run=true
      ;;
    --all)
      for product in $allProducts; do
        selectedProducts[$product]=$product
      done
      ;;
    --root)
      root=$value
      ;;
    --setx)
      set -x
      ;;
    -*)
      product=${switch##--}
      # shellcheck disable=SC1073 # couldn't parse
      # shellcheck disable=SC1072 # fix any mentioned problems
      if (($allProducts[(Ie)$product])); then # if it's a product
        # either add the product (e.g. "--ab"), or override the assumed directory (e.g. "--cc=cc2")
        value=${value//\~/$HOME}
        selectedProducts[$product]=${value:-$product}
        (($#debug)) && typeset -p selectedProducts
      else # it's a normal switch
        switches+=(${1})
      fi
      ;;
    *) # it's a normal argument
      break
      ;;
  esac
  shift
done

# default associative array to cc and px
(($#selectedProducts)) || selectedProducts=(cc cc px px)
(($#debug)) && typeset -p selectedProducts
for prod prodDir in "${(@kv)selectedProducts}"; do
  [[ $prodDir =~ "^/" ]] || prodDir=${root:=.}/${prodDir}
  cd $prodDir
  source ~/bin/gwenv ""

  name="${GW_APPNAME} ${GW_VERSION}"
  command=(rg --color=always ${switches} ${*} $prodDir)
  width=$(($COLUMNS - $#name - 3))

  if (($#debug)); then
    echo "\n==="
    typeset -p command name prod prodDir
    prodDir="[7m${command}"
    width=$(($width + 4)) # 4 unprintable chars
  fi

  printf "\n${GW_ANSI_NAME//$GW_APPNAME/$name%${width}s}\n" ${prodDir//$HOME/\~}

  dry_run || $command || echo
done