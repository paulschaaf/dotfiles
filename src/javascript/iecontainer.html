<html>
<body style="margin:0px;padding:0px;overflow:hidden">

<iframe id="uiFrame" style="margin:0px;padding:0px;height:35px;width:100%;border-style:none">
</iframe>

<div id="theDiv" style="position:relative;width:100%;height:100%;margin:0px;padding:0px;">
<object id="ieObject" style="position:relative;width:100%;height:100%" type="application/blackfish-ietab-plugin"></object>
<script>

var validUiHosts = /(^http:\/\/www\.blackfishsoftware\.com$)/i;

if(!localStorage["regInitialized"])
{
    localStorage["regInitialized"] = true;
    document.getElementById("ieObject").initRegistry();
}

var topUrl = "http://www.blackfishsoftware.com/ietab/topui.html";
var regex = /[?|&]url=([^&].*)/;
var url = document.location.href.toString();
var match = url.match(regex);
if(match) g_currentUrl = decodeURIComponent(match[1]);
else g_currentUrl = "about:blank";

function navigate(url, onComplete)
{
	chrome.tabs.getSelected(null, function(tab) {
		chrome.tabs.update(tab.id, { url: url });
		if(onComplete) onComplete();
	});
}

function buildContainerUrl(childUrl)
{
	var containerUrl = chrome.extension.getURL("iecontainer.html") + "?url=";
	containerUrl += encodeURIComponent(childUrl);
	return containerUrl;
}

function navigateContainer(url)
{
    // Navigate the top frame so this navigation gets into the history and the
    // back / forward queue
	window.top.location = buildContainerUrl(url);
}

function onReturnToChrome()
{
    navigate(g_currentUrl);
}

function onOptions()
{
    document.getElementById("ieObject").showOptions();
}

function onBookmark()
{
    var doAdd = function(id)
    {
        chrome.bookmarks.create({ parentId: id, title: document.title, url: buildContainerUrl(window.g_currentUrl) });
    }

    chrome.bookmarks.getChildren("1", function(result) {
        var idIETab = null;
        for(var i=0; i<result.length; i++)
        {
            // TODO:  Name comparison sucks, but this is all Chromium is giving us for now.
            //        Revisit later.
            if(result[i].title == "IE Tab")
            {
                idIETab = result[i].id;
                break;
            }
        }
        if(idIETab)
        {
            // We have it, go ahead and add it.
            doAdd(idIETab);
        }
        else
        {
            // Create the IE Tab folder, and create the bookmark when that is complete
            chrome.bookmarks.create({ parentId: "1", title: "IE Tab" }, function(node) {
                if(node)
                {
                    doAdd(node.id);
                }
            });
        }
    });
}

function handleResize()
{
    var theDiv = document.getElementById("theDiv");
	var bodyHeight = window.innerHeight;
	theDiv.style.height = bodyHeight - theDiv.offsetTop +  "px";
};

var callbacks = {
    ontitlechange: function(newTitle) {
        document.title = "IE: " + newTitle;
    },
    onnavigatecomplete2: function(url) {
        g_currentUrl = url;
        postMessageToChild({ cmd: "NAVIGATECOMPLETE2", url: url });
    },
    onnewwindow: function(url) {
        chrome.windows.create({ url: buildContainerUrl(url) });
    }
}

function postMessageToChild(msg)
{
    var data = JSON.stringify(msg);
    document.getElementById("uiFrame").contentWindow.postMessage(data, "*");
}

function moveFocusToIE()
{
    window.setTimeout(function() { document.getElementById("ieObject").focus(); }, 500);
}

window.onresize = handleResize;

function onNewMessage(event)
{
    if(!event.origin.match(this.validUiHosts))
        return;

    var msg = JSON.parse(unescape(event.data));

    switch(msg.cmd)
    {
        case "ONUIINIT":
            onUiInit();
            break;
        case "NAVIGATECONTAINER":
            navigateContainer(msg.url);
            break;
        case "RETURNTOCHROME":
            onReturnToChrome();
            break;
        case "SHOWIEOPTIONS":
            onOptions();
            break;
        case "BOOKMARK":
            onBookmark();
            break;
        case "SHOWFILTERS":
            onFilters();
            break;
    }
}

function onUiInit()
{
    var localUrl = chrome.extension.getURL("urls.html");
    postMessageToChild({ cmd: "ONPARENTINIT", startUrl: g_currentUrl, optionsUrl: localUrl });
}

// Add the message event listener to get commands from our UI.
window.addEventListener("message", function(event) {
    onNewMessage(event);
}, false);


window.onload = function() {
    var ieObj = document.getElementById("ieObject");
    ieObj.setNotifications(callbacks);
    ieObj.navigate(g_currentUrl);
    document.title = "IE: " + g_currentUrl;

    var uiFrame = document.getElementById("uiFrame");
    document.getElementById("uiFrame").src = topUrl;

    handleResize();
    moveFocusToIE();
}

</script>

</body>
</html>
