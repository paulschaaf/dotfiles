<?xml version="1.0" ?>

<project
	name="edu-macros"
	basedir=".">
	<description>
		Code common to other build files. This file should declare no
		targets. Paul Schaaf 01/2008
	</description>


	<!-- =========================================================
		==
		==  Local Overrides
		==  Import any extensions or overrides not included with distribution.
		==
		=========================================================== -->

	<!-- The file should look something like this:
		<?xml version="1.0" ?>

		<project name="edu-common_ext" basedir=".">
		<description>
		Property overrides and extensions to the general distribution.
		No targets should be declared in this file.
		</description>

		<import ... />
		<property ... />
		<macrodef ... />

		</project>
	-->
	<import
		file="edu-macros_ext.xml"
		optional="true" />
	<import
		file="../edu-macros_ext.xml"
		optional="true" />


	<!-- =========================================================
		==
		==  Global Property Files
		==
		=========================================================== -->

	<property file="edu-Launch.properties" />
	<property file="../edu-Launch.properties" />
	<property file="bin/registry.properties" />
	<property file="bin/eclipse/build.properties" />

	<property
		name="application.dir"
		value="${tomcat.dir}/webapps/${app.name}" />

	<!-- To use Firefox for GW apps, install the "IE Tab" add-on and use the site filter
		/^http:\/\/.*\/(ab|[bcp]c|ex)\/*.do.*$/
		/^http:\/\/.*((Billing|Claim|Contact|Example|Policy)Center|ExternalLink|InternalTools|Login).do.*$/
		/^http:\/\/.*((Billing|Claim|Contact|Example|Policy)Center|ExternalLink|InternalTools).do.*$/
	-->

	<!-- Use IE if Firefox is not available -->
	<condition
		property="browser.default"
		value="${browser.explorer}">
		<equals
			arg1="${browser.firefox}"
			arg2="" />
	</condition>
	<property
		name="browser.default"
		value="${browser.firefox}" />


	<!-- =========================================================
		==
		==  Debugging
		==
		=========================================================== -->

	<macrodef name="dump-property">
		<attribute name="name" />
		<attribute
			name="level"
			default="info" />
		<sequential>
			<echo
				level="@{level}"
				message="Property: [@{name}] = [${@{name}}]" />
		</sequential>
	</macrodef>


	<!-- =========================================================
		==
		==  External Processes
		==
		=========================================================== -->

	<macrodef name="run">
		<attribute name="executable" />
		<attribute
			name="arguments"
			default="" />
		<attribute
			name="dir"
			default="" />
		<sequential>
			<echo level="info">
				<![CDATA[Running: [@{executable}] [@{arguments}] in [@{dir}]]]>
			</echo>
			<exec
				spawn="true"
				dir="@{dir}"
				executable="@{executable}">
				<arg line="@{arguments}" />
			</exec>
		</sequential>
	</macrodef>

	<macrodef name="console">
		<attribute name="executable" />
		<attribute
			name="arguments"
			default="" />
		<attribute
			name="dir"
			default="" />

		<attribute
			name="colors"
			default="" />
		<attribute
			name="size"
			default="" />
		<attribute
			name="title"
			default="${registry.release} - ${application.url}" />

		<sequential>
			<condition
				property="colors"
				value="@{colors}">
				<not>
					<equals
						arg1="@{colors}"
						arg2="" />
				</not>
			</condition>
			<condition
				property="colors"
				value="${dos.colors}">
				<equals
					arg1="@{executable}"
					arg2="${dos.shell}" />
			</condition>
			<property
				name="colors"
				value="" />

			<echo level="debug">
				<![CDATA[executable = '@{executable}'
				dos.shell = '${dos.shell}']]>
			</echo>

			<run
				dir="@{dir}"
				executable="${dos.shell}"
				arguments="/C start '&quot;@{title}&quot;' @{size} @{executable} ${colors} @{arguments}" />
		</sequential>
	</macrodef>


	<!-- =========================================================
		==
		==  Web browsing
		==
		=========================================================== -->

	<macrodef name="browse">
		<attribute name="url" />
		<!-- protocol is needed for non-http only (like "file") because http url usually already
				contains http and Ant has no string matching functions -->
		<attribute
			name="protocol"
			default="" />
		<attribute
			name="browser"
			default="${browser.default}" />
		<sequential>
			<condition
				property="protocol"
				value="@{protocol}://">
				<not>
					<equals
						arg1="@{protocol}"
						arg2="" />
				</not>
			</condition>
			<property
				name="protocol"
				value="" />
			<!-- PGS: This monkey business with the URL quoting is needed by "explorer.exe", particularly for
				URLs that have parameters or that use a relative path to refer to a local file.-->
			<run
				executable="@{browser}"
				arguments="'&quot;${protocol}@{url}&quot;'" />
		</sequential>
	</macrodef>


	<!-- =========================================================
		==
		==  Guidewire Tools
		==
		=========================================================== -->

	<macrodef name="run-gw-tool">
		<attribute name="classname" />
		<attribute name="message" />
		<element name="args" />
		<sequential>
			<path id="build.classpath">
				<fileset dir="${basedir}/toolkit/lib">
					<include name="**/*.jar" />
				</fileset>
			</path>
			<echo
				level="info"
				message="@{message}" />
			<java
				classname="@{classname}"
				classpathref="build.classpath">
				<arg value="-password" />
				<arg value="gw" />
				<arg value="-server" />
				<arg value="${application.url}" />
				<args />
			</java>
		</sequential>
	</macrodef>

	<macrodef name="gw-import">
		<attribute name="filenamelist" />
		<attribute
			name="dataset"
			default="0" />
		<attribute name="description" />
		<sequential>
			<run-gw-tool
				classname="com.guidewire.cc.webservices.cmdline.ImportToolsMain"
				message="Importing @{description}">
				<args>
					<arg value="-import" />
					<arg value="@{filenamelist}" />
					<arg value="-dataset" />
					<arg value="@{dataset}" />
				</args>
			</run-gw-tool>
		</sequential>
	</macrodef>

	<macrodef name="gw-maintenance">
		<attribute name="process" />
		<attribute
			name="message"
			default="" />
		<sequential>
			<run-gw-tool
				classname="com.guidewire.cc.webservices.cmdline.CCMaintenanceToolsMain"
				message="@{message}">
				<args>
					<arg value="-startprocess" />
					<arg value="@{process}" />
				</args>
			</run-gw-tool>
		</sequential>
	</macrodef>


	<!-- =========================================================
		==
		==  Login
		==
		=========================================================== -->

	<macrodef name="login">
		<attribute
			name="browser"
			default="${browser.gw-app}" />
		<attribute
			name="entrypoint"
			default="Login" />
		<attribute
			name="user"
			default="" />
		<attribute
			name="password"
			default="${default.password}" />
		<attribute
			name="args"
			default="" />

		<sequential>
			<condition
				property="credentials"
				value="">
				<equals
					arg1="@{user}"
					arg2="" />
			</condition>
			<property
				name="credentials"
				value="?loginPassword=@{password}&amp;loginName=@{user}" />

			<condition
				property="args"
				value="">
				<equals
					arg1="@{args}"
					arg2="" />
			</condition>
			<condition
				property="args"
				value="?@{args}">
				<equals
					arg1="${credentials}"
					arg2="" />
			</condition>
			<property
				name="args"
				value="&amp;@{args}" />

			<browse
				browser="@{browser}"
				url="${application.url}/@{entrypoint}.do${credentials}${args}" />

			<!-- IE doesn't handle repeated calls well without a delay. The delay has no 
				effect on a single call as it occurs after the user receives control. -->
			<sleep milliseconds="750" />
		</sequential>
	</macrodef>


	<!-- =========================================================
		==
		==  Misc Tools
		==
		=========================================================== -->

	<macrodef name="launch-diff">
		<attribute
			name="targetdir"
			default="" />
		<sequential>
			<fail
				unless="app.diff"
				message="You must set ${app.diff} to define a diff tool!" />
			<run
				executable="${app.diff}"
				arguments="${basedir}@{targetdir} &quot;${tomcat.dir}/webapps/${app.name}@{targetdir}&quot;" />
		</sequential>
	</macrodef>


</project>